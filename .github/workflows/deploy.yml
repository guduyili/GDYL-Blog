name: Hexo Deploy & Sync

on:
  push:
    paths-ignore:
      - 'source/_GoNotes/**'
      - 'source/_JavaNotes/**'
      - 'source/_PythonNotes/**'
      - 'source/_drafts/**'
      - '.github/**'

jobs:
  build_and_deploy:
    name: Build Hexo Site & Deploy to GitHub Pages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install Dependencies
        run: |
          npm ci --ignore-scripts
          npm audit fix

      - name: Generate Static Files
        run: |
          hexo clean
          hexo generate

      - name: Deploy to GitHub Pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd public
          git init
          git checkout -b gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Deploy: ${{ github.sha }}"
          git remote add origin https://github.com/guduyili/GDYL-Blog.git
          git push -f origin gh-pages

  sync_to_gitee:
    name: Sync to Gitee Repository
    needs: build_and_deploy
    runs-on: ubuntu-latest
    steps:
      - name: Mirror Repository
        uses: wearerequired/git-mirror-action@v1
        env:
          SSH_PRIVATE_KEY: ${{ secrets.HEXO_DEPLOY_KEY }}
        with:
          source-repo: "git@github.com:guduyili/GDYL-Blog.git"
          destination-repo: "git@gitee.com:Absolutelynothing/GDYL-Blog.git"

  build_gitee_pages:
    name: Trigger Gitee Pages Build
    needs: sync_to_gitee
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Gitee Pages
        uses: yanglbme/gitee-pages-action@main
        with:
          gitee-username: 后藤一里
          gitee-password: ${{ secrets.GITEE_PASSWORD }}
          gitee-repo: 后藤一里/GDYL-Blog
          branch: gh-pages
